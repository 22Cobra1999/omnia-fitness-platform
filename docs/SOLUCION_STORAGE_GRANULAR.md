# üéØ Soluci√≥n: Tracking de Archivos por Archivo Individual

## üìä El Problema

Actualmente `storage_usage` agrupa TODO por tipo de archivo (video/image/pdf) y lista **TODAS** las actividades del coach, sin importar si realmente usan ese archivo.

### Ejemplo Real de tu DB:

```sql
-- Lo que tienes ahora (INCORRECTO)
INSERT INTO storage_usage VALUES
  (1, 'b16c4f8c...', 'video', 0.032, '[90, 59, 48, 78]', ...),
  (2, 'b16c4f8c...', 'image', 0.000, '[90, 59, 48, 78]', ...);
```

**Esto dice:** "Las actividades 90, 59, 48, 78 tienen videos"

**Pero en realidad puede ser:**
- Video A solo est√° en actividad 90
- Video B solo est√° en actividad 59
- Actividades 48 y 78 no tienen videos

---

## ‚úÖ La Soluci√≥n

Crear una nueva tabla `storage_files` que rastrea **cada archivo individual** y **en qu√© actividades se usa**.

### Nueva Estructura:

```sql
CREATE TABLE storage_files (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  coach_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Tipo de archivo
  concept TEXT NOT NULL CHECK (concept IN ('video', 'image', 'pdf', 'other')),
  
  -- Identificaci√≥n del archivo
  file_id TEXT NOT NULL,              -- Para videos: bunny_video_id, para archivos: UUID o hash
  file_name TEXT,                     -- Nombre descriptivo
  file_url TEXT,                      -- URL completa
  
  -- Tama√±o
  size_bytes BIGINT NOT NULL,         -- Tama√±o en bytes
  gb_usage DECIMAL(12, 6) GENERATED ALWAYS AS (size_bytes / 1073741824.0) STORED,
  
  -- De d√≥nde viene
  source_table TEXT NOT NULL CHECK (source_table IN ('activity_media', 'ejercicios_detalles', 'nutrition_program_details', 'direct')),
  source_id BIGINT,                   -- ID en la tabla de origen
  
  -- D√≥nde se usa
  activity_id BIGINT NOT NULL REFERENCES activities(id),
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices
CREATE INDEX idx_storage_files_coach_id ON storage_files(coach_id);
CREATE INDEX idx_storage_files_activity_id ON storage_files(activity_id);
CREATE INDEX idx_storage_files_file_id ON storage_files(file_id);
CREATE INDEX idx_storage_files_concept ON storage_files(concept);
```

---

## üìù Ejemplo de Datos Reales

```sql
-- Video √∫nico "abc-123" usado en actividad 90
INSERT INTO storage_files VALUES
  (1, 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f', 
   'video', 'bunny-video-abc-123', 'Clase Yoga.mp4',
   'https://iframe.mediadelivery.net/embed/bunny-video-abc-123',
   15728640, -- 15 MB
   'activity_media', 1, 90, NOW(), NOW());

-- Mismo video usado en OTRA referencia (ej: ejercicio detalle)
INSERT INTO storage_files VALUES
  (2, 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f',
   'video', 'bunny-video-abc-123', 'Clase Yoga.mp4',
   'https://iframe.mediadelivery.net/embed/bunny-video-abc-123',
   15728640, -- 15 MB (MISMO archivo, se cuenta 1 vez)
   'ejercicios_detalles', 5, 90, NOW(), NOW());

-- Video diferente "xyz-789" usado en actividad 59
INSERT INTO storage_files VALUES
  (3, 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f',
   'video', 'bunny-video-xyz-789', 'Cardio Intenso.mp4',
   'https://iframe.mediadelivery.net/embed/bunny-video-xyz-789',
   16777216, -- 16 MB
   'activity_media', 10, 59, NOW(), NOW());

-- Imagen usada en actividad 48
INSERT INTO storage_files VALUES
  (4, 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f',
   'image', 'img-banner-456', 'Banner Actividad.jpg',
   'https://supabase.co/storage/v1/object/public/product-media/coaches/b16c4f8c.../images/banner.jpg',
   524288, -- 512 KB
   'activity_media', 15, 48, NOW(), NOW());
```

---

## üîç Consultas √ötiles

### Ver todos los archivos de un coach con detalle:

```sql
SELECT 
  sf.concept,
  sf.file_name,
  ROUND(sf.gb_usage * 1024, 2) as mb_usage,
  sf.activity_id,
  a.title as actividad_nombre,
  sf.source_table,
  sf.file_url
FROM storage_files sf
INNER JOIN activities a ON sf.activity_id = a.id
WHERE sf.coach_id = 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f'
ORDER BY sf.concept, sf.gb_usage DESC;
```

**Resultado:**
```
concept | file_name          | mb_usage | activity_id | actividad_nombre | source_table    | file_url
--------|-------------------|----------|-------------|------------------|-----------------|----------
video   | Clase Yoga.mp4    | 15.0     | 90          | Yoga Matutino    | activity_media  | https://...
video   | Cardio Intenso.mp4| 16.0     | 59          | Cardio           | activity_media  | https://...
image   | Banner Actividad   | 0.5      | 48          | Entrenamiento... | activity_media  | https://...
```

### Ver qu√© actividades usan un archivo espec√≠fico:

```sql
SELECT 
  sf.activity_id,
  a.title as actividad_nombre,
  sf.file_name,
  sf.source_table
FROM storage_files sf
INNER JOIN activities a ON sf.activity_id = a.id
WHERE sf.file_id = 'bunny-video-abc-123';
```

**Resultado:**
```
activity_id | actividad_nombre | file_name    | source_table
-----------|-------------------|--------------|----------------
90         | Yoga Matutino    | Clase Yoga   | activity_media
90         | Yoga Matutino    | Clase Yoga   | ejercicios_detalles
```

### Ver resumen agregado (como storage_usage actual):

```sql
SELECT 
  coach_id,
  concept,
  SUM(gb_usage) as total_gb,
  COUNT(DISTINCT file_id) as archivos_unicos,
  COUNT(DISTINCT activity_id) as actividades_que_usan,
  jsonb_agg(DISTINCT activity_id ORDER BY activity_id) as activity_ids
FROM storage_files
WHERE coach_id = 'b16c4f8c-f47b-4df0-ad2b-13dcbd76263f'
GROUP BY coach_id, concept;
```

**Resultado:**
```
coach_id | concept | total_gb | archivos_unicos | actividades_que_usan | activity_ids
---------|---------|----------|-----------------|----------------------|--------------
b16c4f8c | video   | 0.031    | 2               | 2                    | [59, 90]
b16c4f8c | image   | 0.0005   | 1               | 1                    | [48]
```

**¬°Ahora s√≠ es correcto!** Solo muestra actividades que **realmente** usan esos archivos.

---

## üîÑ C√≥mo Migrar

### Paso 1: Crear la tabla

```bash
db/migrations/YYYYMMDD_create_storage_files_table.sql
```

### Paso 2: Poblar con datos hist√≥ricos

Script que lee de:
- `activity_media`
- `ejercicios_detalles`
- `nutrition_program_details`

Y crea una fila por cada archivo/usuario.

### Paso 3: Actualizar API `/api/coach/storage-usage`

Ahora guarda en `storage_files` en lugar de `storage_usage`.

### Paso 4: Crear vista compatible (opcional)

Para mantener compatibilidad con c√≥digo existente:

```sql
CREATE VIEW storage_usage_v2 AS
SELECT 
  coach_id,
  concept,
  SUM(gb_usage) as gb_usage,
  jsonb_agg(DISTINCT activity_id ORDER BY activity_id) as products,
  MIN(created_at) as created_at,
  MAX(updated_at) as updated_at
FROM storage_files
GROUP BY coach_id, concept;
```

---

## üéØ Beneficios

1. ‚úÖ **Granular:** Sabes exactamente qu√© archivo usa qu√© actividad
2. ‚úÖ **Deduplicable:** Mismo video usado en 2 lugares se cuenta 1 vez
3. ‚úÖ **Rastreable:** Encuentras archivos hu√©rfanos f√°cilmente
4. ‚úÖ **Auditable:** Ves historial de uso de cada archivo
5. ‚úÖ **Limpieza:** Puedes eliminar archivos no usados autom√°ticamente

---

## ‚ö†Ô∏è C√≥mo Ver Tus Datos Actuales

He creado el archivo `QUERIES_DEBUG_STORAGE.sql` con queries para ver:
- Qu√© archivos reales tienes
- En qu√© actividades est√°n
- La diferencia entre lo que dice `storage_usage` vs la realidad

Ejecuta esas queries en Supabase SQL Editor para entender tu situaci√≥n actual.

---

## üöÄ ¬øSiguientes Pasos?

1. Revisa `QUERIES_DEBUG_STORAGE.sql` para entender tus datos
2. Revisa `PROPUESTA_STORAGE_GRANULAR.md` para detalles t√©cnicos
3. Decidimos si implementamos la nueva tabla o mejoramos la actual





























