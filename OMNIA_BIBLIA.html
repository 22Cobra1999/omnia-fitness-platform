<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Biblia Omnia</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }

    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }

    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }

    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }

      p,
      h2,
      h3 {
        orphans: 3;
        widows: 3;
      }

      h2,
      h3,
      h4 {
        page-break-after: avoid;
      }
    }

    p {
      margin: 1em 0;
    }

    a {
      color: #1a1a1a;
    }

    a:visited {
      color: #1a1a1a;
    }

    img {
      max-width: 100%;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin-top: 1.4em;
    }

    h5,
    h6 {
      font-size: 1em;
      font-style: italic;
    }

    h6 {
      font-weight: normal;
    }

    ol,
    ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }

    li>ol,
    li>ul {
      margin-top: 0;
    }

    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }

    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }

    pre {
      margin: 1em 0;
      overflow: auto;
    }

    pre code {
      padding: 0;
      overflow: visible;
    }

    .sourceCode {
      background-color: transparent;
      overflow: visible;
    }

    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }

    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }

    table caption {
      margin-bottom: 0.75em;
    }

    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }

    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }

    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }

    header {
      margin-bottom: 4em;
      text-align: center;
    }

    #TOC li {
      list-style: none;
    }

    #TOC a:not(:hover) {
      text-decoration: none;
    }

    code {
      white-space: pre-wrap;
    }

    span.smallcaps {
      font-variant: small-caps;
    }

    span.underline {
      text-decoration: underline;
    }

    div.column {
      display: inline-block;
      vertical-align: top;
      width: 50%;
    }

    div.hanging-indent {
      margin-left: 1.5em;
      text-indent: -1.5em;
    }

    ul.task-list {
      list-style: none;
    }

    .display.math {
      display: block;
      text-align: center;
      margin: 0.5rem auto;
    }

    /* Visual Logic Map Styles */
    .logic-container {
      background: #0a0b0d;
      color: #e0e0e0;
      padding: 25px;
      border-radius: 16px;
      font-family: 'Menlo', 'Monaco', monospace;
      font-size: 13px;
      margin: 2em 0;
      border: 1px solid #1f2023;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .logic-title {
      color: #FF7939;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }

    .logic-layer {
      margin-bottom: 15px;
      padding-left: 15px;
      border-left: 2px solid #444;
    }

    .layer-label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
      display: block;
    }

    .node {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      margin: 4px 0;
    }

    .ux-node {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #444;
    }

    .hook-node {
      background: rgba(0, 150, 255, 0.1);
      border: 1px solid #0077ff;
      color: #4faaff;
    }

    .api-node {
      background: rgba(255, 165, 0, 0.1);
      border: 1px solid #ffae00;
      color: #ffae00;
    }

    .state-node {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4caf50;
      color: #81c784;
    }

    .arrow {
      color: #555;
      margin: 0 5px;
    }

    .branch {
      padding-left: 20px;
      border-left: 1px dashed #333;
      margin-top: 5px;
    }

    /* Tree Design Styles */
    .tree-container {
      background: #0d1117;
      color: #c9d1d9;
      padding: 40px;
      border-radius: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
      font-size: 13px;
      line-height: 2;
      border: 1px solid #30363d;
      margin: 20px 0;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.8);
      position: relative;
    }

    .tree-title {
      color: #58a6ff;
      font-weight: bold;
      font-size: 20px;
      border-bottom: 2px solid #1f6feb;
      margin-bottom: 30px;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .tree-division {
      color: #ff7b72;
      font-weight: bold;
      font-size: 16px;
      margin-top: 30px;
      display: block;
      padding: 5px 10px;
      background: rgba(255, 123, 114, 0.1);
      border-radius: 4px;
      width: fit-content;
    }

    .tree-branch {
      position: relative;
      margin-left: 20px;
      border-left: 1px solid #30363d;
      padding-left: 20px;
    }

    .tree-tab {
      color: #d2a8ff;
      display: block;
      position: relative;
      font-weight: bold;
    }

    .tree-tab:before {
      content: "";
      position: absolute;
      left: -20px;
      top: 15px;
      width: 15px;
      border-top: 1px solid #30363d;
    }

    .tree-action {
      color: #79c0ff;
      margin-left: 20px;
      display: block;
      position: relative;
    }

    .tree-action:before {
      content: "";
      position: absolute;
      left: -20px;
      top: 15px;
      width: 15px;
      border-top: 1px solid #30363d;
    }

    .tree-detail {
      margin-left: 40px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #8b949e;
      position: relative;
    }

    .tree-detail:before {
      content: "";
      position: absolute;
      left: -20px;
      top: 15px;
      width: 15px;
      border-top: 1px solid #30363d;
    }

    .status-pill {
      font-size: 9px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pill-green {
      background: #238636;
      color: #fff;
      box-shadow: 0 0 10px rgba(35, 134, 54, 0.3);
    }

    .pill-yellow {
      background: #9e6a03;
      color: #fff;
      box-shadow: 0 0 10px rgba(158, 106, 3, 0.3);
    }

    .pill-red {
      background: #da3633;
      color: #fff;
      box-shadow: 0 0 10px rgba(218, 54, 51, 0.3);
    }

    .pill-blue {
      background: #1f6feb;
      color: #fff;
      box-shadow: 0 0 10px rgba(31, 111, 235, 0.3);
    }

    .line-count {
      color: #484f58;
      font-size: 11px;
      background: #161b22;
      padding: 0 6px;
      border-radius: 3px;
    }

    code {
      background: none !important;
      color: #c9d1d9 !important;
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>

<body>
  <header id="title-block-header">
    <h1 class="title">Biblia Omnia</h1>
  </header>
  <h1 id="omnia-la-biblia-completa-del-sistema">üìñ OMNIA: La Biblia Completa del Sistema</h1>
  <p>Bienvenido al repositorio central de conocimiento t√©cnico de Omnia. Este documento consolida todos los flujos de
    datos, consultas cr√≠ticas y procesos de carga tanto para el Cliente como para el Coach.</p>
  <hr />

  <h2 id="business-idea">üí° Idea de Negocio: OMNIA</h2>
  <div class="logic-container" style="background: #0f1218; border: 1px solid #30363d;">
    <div class="logic-title" style="color: #FF7939; border-color: #FF7939;">üéØ MISI√ìN: POTENCIAR EL FITNESS DIGITAL
    </div>
    <p style="margin-top: 10px; color: #ccc;">
      <strong>OMNIA</strong> es una plataforma premium dise√±ada para conectar a los mejores Coaches de fitness con
      Clientes
      que buscan resultados reales.
    </p>
    <ul style="color: #bbb; list-style-type: disc; margin-left: 20px;">
      <li><strong>Para Coaches:</strong> Herramientas profesionales de gesti√≥n, monetizaci√≥n automatizada, y branding
        personal. Eliminamos el caos administrativo para que puedan enfocarse en entrenar.</li>
      <li><strong>Para Clientes:</strong> Una experiencia de entrenamiento inmersiva, seguimiento de progreso en tiempo
        real y acceso a un marketplace curado de servicios de salud.</li>
      <li><strong>Modelo de Negocio:</strong> SaaS + Marketplace. Suscripciones para Coaches (Free, B√°sico, Black,
        Premium) y comisiones por transacciones seguras v√≠a Mercado Pago.</li>
    </ul>
  </div>

  <h2 id="ux-philosophy">‚ú® Filosof√≠a UX: "Premium & Fluid"</h2>
  <div class="logic-container" style="background: #0f1218; border: 1px solid #30363d;">
    <div class="logic-title" style="color: #a371f7; border-color: #a371f7;">üíé PILARES DE DISE√ëO</div>
    <div class="logic-layer">
      <span class="layer-label">EST√âTICA</span>
      <div class="node ux-node">Dark Mode Nativo ‚Ä¢ Glassmorphism (Blur 20px+) ‚Ä¢ Acentos Ne√≥n (#FF7939)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">INTERACCI√ìN</span>
      <div class="node ux-node">Feedback H√°ptico ‚Ä¢ Transiciones Framer Motion ‚Ä¢ Carga Skeleton "Shimmer"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">ACCESIBILIDAD</span>
      <div class="node ux-node">Contraste Alto ‚Ä¢ √Åreas de Toque >44px ‚Ä¢ Tipograf√≠a Inter/Outfit</div>
    </div>
  </div>


  <h2 id="sala-de-trofeos">üèÜ Sala de Trofeos (Monsters Hunted)</h2>
  <div class="logic-container" style="background: #0f1218; border: 1px solid #30363d;">
    <div class="logic-title" style="color: #e3b341; border-color: #e3b341;">üíÄ MONSTRUOS ABATIDOS</div>

    <div class="logic-layer">
      <span class="layer-label">EL PERFIL HOL√çSTICO</span>
      <div class="node" style="background: #da3633; color: white;">ClientProfileView.tsx (Original: ~469 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-blue">Reducido a ~140 l√≠neas (70% de compresi√≥n). Modularizado en Header, Activity,
          Metrics y History.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL BUSCADOR SUPREMO</span>
      <div class="node" style="background: #da3633; color: white;">search-screen.tsx (Original: ~473 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-blue">Reducido a ~150 l√≠neas. L√≥gica en useSearchScreenLogic. UI en SearchHeader, Filters
          y Results.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL OR√ÅCULO DEL CHAT</span>
      <div class="node" style="background: #da3633; color: white;">messages/page.tsx (Original: ~501 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-blue">Reducido a ~98 l√≠neas (80% de compresi√≥n). L√≥gica Real-time en useMessagesLogic. UI
          en 4 componentes.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL MERCADER DE PAGOS</span>
      <div class="node" style="background: #da3633; color: white;">PurchaseActivityModal.tsx (Original: ~503 l√≠neas)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-blue">Reducido a ~120 l√≠neas (76% de compresi√≥n). L√≥gica en usePurchaseActivityLogic. UI
          en 4 componentes especializados.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL LEVIAT√ÅN (ORIGINAL)</span>
      <div class="node" style="background: #da3633; color: white;">TodayScreen_OLD.tsx (ELIMINADO üóëÔ∏è)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è REFACTORIZADO EN</span>
        <div class="node pill-blue">Modules: Header, ActivityList, Hooks (~236 l√≠neas core)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL LABERINTO DE PRODUCTOS</span>
      <div class="node" style="background: #da3633; color: white;">products-management-screen_OLD.tsx (ELIMINADO üóëÔ∏è)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO EN</span>
        <div class="node pill-blue">Index (~89 l√≠neas) + Logic Hooks (~570 l√≠neas)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL PLANIFICADOR DEL CAOS</span>
      <div class="node" style="background: #9e6a03; color: white;">DayExercisesModal.tsx (Complejidad L√≥gica
        Exponencial)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è OPTIMIZADO EN</span>
        <div class="node pill-green">~430 l√≠neas (Datos Blindados + UI Premium)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">LA DUPLICADORA DE MEETS</span>
      <div class="node" style="background: #da3633; color: white;">CalendarView.tsx (Bug Cr√≠tico: Duplicaci√≥n de Meets)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y ELIMINADO</span>
        <div class="node pill-green">Flujo de Reschedule Unificado + Modal de Confirmaci√≥n Premium</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL COLOSO DEL COACH</span>
      <div class="node" style="background: #da3633; color: white;">coach-calendar-screen.tsx (Original: ~3,142 l√≠neas)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è FRAGMENTADO Y DOMADO</span>
        <div class="node pill-blue">Reducido a ~160 l√≠neas (95% compresi√≥n). L√≥gica en 5 Hooks especializados. UI en 3
          componentes modulares.
        </div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL LEVIAT√ÅN DEL CLIENTE</span>
      <div class="node" style="background: #da3633; color: white;">CalendarView.tsx (Original: ~4,000 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-green">Reducido a ~450 l√≠neas (88% compresi√≥n). Arquitectura Manager-View con 5 Vistas
          Modulares.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL GUARDI√ÅN DEL DETALLE</span>
      <div class="node" style="background: #9e6a03; color: white;">MeetDetailModal.tsx (Original: ~800 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è MODULARIZADO</span>
        <div class="node pill-green">Reducido a ~460 l√≠neas. UI dividida en Header, Info, Participants, Actions y
          Confirmations.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL TIT√ÅN DE LOS INSIGHTS</span>
      <div class="node" style="background: #da3633; color: white;">fitness-insights.tsx (Original: ~1,400 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-green">Reducido a 120 l√≠neas (90% de compresi√≥n). L√≥gica extra√≠da a useFitnessInsights,
          datos a fitness-insights-data, y UI en 7 sub-componentes.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL COLOSO DE LAS REGLAS</span>
      <div class="node" style="background: #da3633; color: white;">conditional-rules-panel.tsx (Original: ~1,100 l√≠neas)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-green">Reducido a 140 l√≠neas (87% de compresi√≥n). L√≥gica extra√≠da a useConditionalRules,
          datos a conditional-rules-data, y UI en sub-componentes especializados.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL TIT√ÅN DEL PROGRESO</span>
      <div class="node" style="background: #da3633; color: white;">goals-progress.tsx (Original: ~1,140 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-green">Reducido a 60 l√≠neas (95% de compresi√≥n). L√≥gica extra√≠da a useGoalsProgress,
          datos a goals-progress-data, y UI en sub-componentes modulares.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL GENERAL DEL CSV</span>
      <div class="node" style="background: #da3633; color: white;">csv-manager-enhanced.tsx (Original: ~1,035 l√≠neas)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CAZADO Y FRAGMENTADO</span>
        <div class="node pill-green">Reducido a ~350 l√≠neas (66% de compresi√≥n). L√≥gica extra√≠da a 7 hooks
          especializados
          y UI modularizada en componentes at√≥micos.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL MONSTRUO DE LAS REGLAS</span>
      <div class="node" style="background: #da3633; color: white;">RuleEditor.tsx (Original: ~600 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-green">Orquestador de ~100 l√≠neas. L√≥gica en useRuleEditorLogic. UI en 5 sub-componentes.
        </div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL GIGANTE DEL PREVIEW</span>
      <div class="node" style="background: #da3633; color: white;">ProductPreviewCard.tsx (Original: ~600 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-green">Orquestador de ~100 l√≠neas. L√≥gica de Drag-to-Buy en hook. UI en 4 sub-componentes.
        </div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL ADMINISTRADOR DE PRECIOS</span>
      <div class="node" style="background: #da3633; color: white;">plan-management.tsx (Original: ~615 l√≠neas)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-green">Orquestador de ~140 l√≠neas. Data est√°tica separada. UI en 4 sub-componentes
          modulares.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">EL OVERLAY DE LOS DETALLES</span>
      <div class="node" style="background: #da3633; color: white;">ActivityDetailOverlay.tsx (Original: ~570 l√≠neas)
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-green">Orquestador de ~194 l√≠neas. L√≥gica en Hook. UI modularizada en 4 componentes
          especializados.</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">MOTOR ADAPTATIVO OMNIA v3.0</span>
      <div class="node" style="background: #238636; color: white;">lib/omnia-adaptive-motor.ts (EVOLUCIONADO üöÄ)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è INTEGRACI√ìN TOTAL</span>
        <div class="node pill-green">Sustituye la tabla legacy `product_conditional_rules` por `activities.adaptive_config`. Soporte para blindajes de seguridad, acumulacion de riesgos y motor whitelisted.</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">EL TIT√ÅN DE LA INICIALIZACI√ìN</span>
      <div class="node" style="background: #da3633; color: white;">initialize-progress/route.ts (ADAPTADO v3.0)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DOMADO</span>
        <div class="node pill-green">Ahora utiliza el Motor Adaptativo v3.0 para inyectar prescripciones personalizadas whitelisted durante la compra del producto.
        </div>
      </div>
    </div>
  </div>
  <h2 id="√≠ndice-de-navegaci√≥n">üìë √çndice de Navegaci√≥n</h2>
  <h3 id="aplicaci√≥n-del-cliente-client-app">üë§ Aplicaci√≥n del Cliente (Client App)</h3>
  <ol type="1">
    <li><a href="#explorar-marketplace"><strong>Explorar / Marketplace</strong></a>: Descubrimiento y compra de
      productos.</li>
    <li><a href="#mis-actividades"><strong>Mis Actividades</strong></a>: Seguimiento de progreso y consumo.</li>
    <li><a href="#calendario-cliente"><strong>Calendario del Cliente</strong></a>: Gesti√≥n de turnos y eMeets.</li>
    <li><a href="#perfil-cliente"><strong>Perfil del Cliente</strong></a>: Datos personales, biometr√≠a y metas.</li>
    <li><a href="#comunidad-cliente"><strong>Comunidad</strong></a>: Feed social e interacciones.</li>
    <li><a href="#mensajeria-cliente"><strong>Mensajer√≠a</strong></a>: Chat directo con coaches.</li>
  </ol>
  <h3 id="panel-del-coach-coach-dashboard">üë®‚Äçüè´ Panel del Coach (Coach Dashboard)</h3>
  <ol start="7" type="1">
    <li><a href="#gestion-clientes-coach"><strong>Gesti√≥n de Clientes</strong></a>: Cartera y detalle de evoluci√≥n.
    </li>
    <li><a href="#gestion-productos-coach"><strong>Gesti√≥n de Productos</strong></a>: Creaci√≥n de ejercicios y
      nutrici√≥n.</li>
    <li><a href="#calendario-coach"><strong>Calendario del Coach</strong></a>: Disponibilidad y sincronizaci√≥n
      eMeet.
    </li>
    <li><a href="#gestion-video-coach"><strong>Gesti√≥n de Videos (Bunny.net)</strong></a>: Subida y streaming.</li>
    <li><a href="#gestion-documentos-coach"><strong>Gesti√≥n de Documentos</strong></a>: Estructura de PDFs y temas.
    </li>
    <li><a href="#perfil-coach"><strong>Perfil del Coach</strong></a>: Configuraci√≥n y marca personal.</li>
  </ol>
  <h3 id="l√≥gica-y-arquitectura-t√©cnica">üß† L√≥gica y Arquitectura T√©cnica</h3>
  <ol start="13" type="1">
    <li><a href="#onboarding-logic"><strong>Formulario de Onboarding</strong></a>: L√≥gica de admisi√≥n.</li>
    <li><a href="#progreso-logic"><strong>Generaci√≥n de Progreso</strong></a>: El ‚ÄúMotor de Instanciaci√≥n‚Äù.</li>
    <li><a href="#script-audit"><strong>Auditor√≠a de Scripts y QA</strong></a>: Dashboard de eficiencia y deuda
      t√©cnica.
    </li>
    <li><a href="#logic-map"><strong>Mapa de Salud Operativa y Estructura</strong></a>: Arquitectura Visual de
      Omnia.
    </li>
    <li><a href="#master-purchase-flow"><strong>Flujo Maestro de Compra Personalizada</strong></a>: El Core de la
      Plataforma.</li>
  </ol>
  <p><a name="explorar-marketplace"></a> ## 1. üîç Explorar / Marketplace (Client)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Descubrimiento y Conversi√≥n</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Scroll Marketplace ‚Üí Search "Running" ‚Üí Click ActivityCard</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">search-screen.tsx: handleSearchChange() ‚Üí filterActivities()</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node hook-node">handleActivityClick() ‚Üí setNavigationStack()</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">GET /api/activities/search?q=running</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">View: activities_with_coaches (Pre-mapped)</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: isPreviewModalOpen = true ‚Üí [ClientProductModal]</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> La b√∫squeda local `filterActivities` es r√°pida pero puede
    desincronizarse si el coach cambia el precio mientras el cliente navega. <em>Optimizaci√≥n:</em> Implementar
    validaci√≥n de precio final en el √∫ltimo step del checkout.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="mis-actividades"></a> ## 2. üèÉ Mis Actividades (Client)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Consumo de Producto</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Click en "Actividades" Tab ‚Üí Selecciona "En curso"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">TodayScreen: useTodayScreenLogic() ‚Üí filterByStatus("in_progress")</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">RPC: get_user_enrolled_activities(user_id)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: enrolledActivitiesList ‚Üí Render ActivityCard con % progreso</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> El c√°lculo de `% progreso` ocurre on-the-fly.
    <em>Optimizaci√≥n:</em>
    Persistir el % en `activity_enrollments` cada vez que se marca un item como completado para evitar recalculadas
    costosas.
  </p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="calendario-cliente"></a> ## 3. üìÖ Calendario del Cliente (Client)</p>

  <div class="logic-container">
    <div class="logic-title">üåÄ Flujo Completo de Meets: Creaci√≥n, Modificaci√≥n y Cancelaci√≥n</div>

    <div class="logic-layer">
      <span class="layer-label">üìå ESCENARIO 0: Recibir Invitaci√≥n de Coach</span>
      <div class="node ux-node">Client: Recibe Notificaci√≥n / Ve Turno "Pendiente" en Calendario</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è ACCI√ìN</span>
        <div class="node ux-node">Click en "Confirmar Asistencia"</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è DATABASE</span>
        <div class="node api-node">UPDATE calendar_event_participants SET rsvp_status = 'confirmed'</div>
        <div class="node state-node">UI: Turno cambia a color s√≥lido (Confirmado)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå ESCENARIO 1: Crear Nueva Meet</span>
      <div class="node ux-node">Client: Selecciona coach ‚Üí Elige fecha/hora ‚Üí Click "Confirmar Reserva"</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node api-node">INSERT calendar_events { title, start_time, end_time, coach_id, client_id,
          status:
          'scheduled' }</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node api-node">INSERT calendar_event_participants { event_id, client_id, rsvp_status: 'pending',
          invited_by_user_id: client_id }</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node state-node">UI: Modal de √©xito ‚Üí Calendario actualizado</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå ESCENARIO 2: Modificar Meet Pendiente (Cliente Creador)</span>
      <div class="node ux-node">Client: Click en meet ‚Üí "Modificar horario" ‚Üí Selecciona nuevo slot ‚Üí "Confirmar"
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è VERIFICACI√ìN</span>
        <div class="node hook-node">rescheduleContext detectado ‚Üí Fetch participant data</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CONDICI√ìN</span>
        <div class="node api-node">IF (rsvp_status === 'pending' && invited_by_user_id === client_id)</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è ACCI√ìN</span>
        <div class="node api-node" style="background: #2ea043; color: white;">UPDATE calendar_events SET start_time,
          end_time WHERE id = event_id</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node state-node">‚úÖ Meet actualizada (NO duplicada) ‚Üí Modal de √©xito</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå ESCENARIO 3: Modificar Meet Confirmada</span>
      <div class="node ux-node">Client: Click en meet confirmada ‚Üí "Reprogramar" ‚Üí Selecciona nuevo slot</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è VERIFICACI√ìN</span>
        <div class="node hook-node">rescheduleContext detectado ‚Üí Fetch participant data</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è CONDICI√ìN</span>
        <div class="node api-node">IF (rsvp_status === 'confirmed' || 'accepted')</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è ACCI√ìN</span>
        <div class="node state-node">UI: Modal de preview de reschedule ‚Üí Requiere confirmaci√≥n del coach</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå ESCENARIO 4: Cancelar Meet</span>
      <div class="node ux-node">Client: Click en meet ‚Üí "Cancelar solicitud" / "Cancelar mi asistencia"</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node state-node" style="background: #1f2937; color: white;">UI: Modal de confirmaci√≥n
          personalizado
          (glassmorphism)</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è SI CONFIRMA</span>
        <div class="node api-node">UPDATE calendar_events SET status = 'cancelled' WHERE id = event_id</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node api-node">UPDATE calendar_event_participants SET rsvp_status = 'cancelled'</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è</span>
        <div class="node state-node">Toast: "Asistencia cancelada" ‚Üí Calendario actualizado</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üîß COMPONENTES CLAVE</span>
      <div class="node hook-node">CalendarView.tsx: handleTimelineClick(), confirmaci√≥n en modal y day_split</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node hook-node">MeetDetailModal.tsx: handleSuggestNewTime(), handleCancel(), confirmCancel()
        </div>
      </div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">rescheduleContext: { eventId, originalTitle, originalDescription }</div>
      </div>
    </div>
  </div>

  <p><strong>üêõ Bug Cr√≠tico Resuelto:</strong> Duplicaci√≥n de meets al modificar horario. El sistema ahora verifica
    el
    estado del meet (pending vs confirmed) y el rol del usuario (creador vs invitado) para decidir si actualizar el
    evento existente o crear una solicitud de reschedule.</p>
  <p><strong>üé® UX Premium:</strong> Modal de confirmaci√≥n personalizado con glassmorphism reemplaza el
    window.confirm
    nativo del navegador.</p>
  <p><strong>‚ö° Optimizaci√≥n de Reprogramaci√≥n:</strong> Para eventos creados por el usuario que a√∫n est√°n pendientes, se
    utiliza una <em>Actualizaci√≥n Directa</em> (Overwrite) en lugar de crear una nueva solicitud, evitando la
    fragmentaci√≥n de la agenda y duplicados innecesarios.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="perfil-cliente"></a> ## 4. üë§ Perfil del Cliente (Client)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Actualizaci√≥n Biom√©trica</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Abre biometrics-modal ‚Üí Ingresa "Peso: 85kg" ‚Üí Save</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">biometrics-modal.tsx: handleSave() ‚Üí supabase.upsert()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">Table: user_biometrics (New Row with timestamp)</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">DB Table: clients (Update current_weight)</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: userStats ‚Üí re-render Rings de Actividad</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> No hay validaci√≥n de rangos extremos (ej. peso 1000kg).
    <em>Optimizaci√≥n:</em> Agregar validaci√≥n de Z-score para alertar al usuario sobre errores de entrada.
  </p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="comunidad-cliente"></a> ## 5. ü§ù Comunidad (Client)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Feed Social</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Escribe Post ‚Üí Click "Publicar"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">community-screen.tsx: handleCreatePost()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">INSERT table: community_posts { user_id, content, media }</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: postsFeed (Unshift new post) ‚Üí UI: Feed Update</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Inyecci√≥n de scripts en el content. <em>Optimizaci√≥n:</em>
    Sanitizar el
    HTML/Markdown en el cliente y doble check en el DB Trigger.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="mensajeria-cliente"></a> ## 6. üí¨ Mensajer√≠a (Client)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Chat Real-Time</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Escribe mensaje ‚Üí Send</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">messages-screen.tsx: handleSendMessage() ‚Üí Supabase Subscription</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">INSERT table: messages { chat_id, content }</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">Broadcast: REALTIME payload to recipient</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: activeChatMessages (Push new msg)</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Flooding de mensajes. <em>Optimizaci√≥n:</em> Implementado l√≠mite
    diario
    de 10 mensajes por chat por usuario. Bloqueo hasta 00:00hs.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="gestion-clientes-coach"></a> ## 7. üë• Gesti√≥n de Clientes (Coach)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Auditor√≠a de Evoluci√≥n</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Coach: Click en Cliente "Franco" ‚Üí Tab "Progreso"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">clients-screen.tsx: loadClientDetailedData()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">View: client_evolution_chart (Aggregation of 30 days)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: selectedClientStats ‚Üí Recharts: LineGraph</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Acceso a clientes de otro coach via URL. <em>Optimizaci√≥n:</em> RLS
    (Row Level Security) estricto en Supabase verificado: `coach_id = auth.uid()`.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="gestion-productos-coach"></a> ## 8. üõí Gesti√≥n de Productos (Coach)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Gesti√≥n de Inventario Comercial</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Coach: Toggle "Caf√© de Consulta" ‚Üí Change Price</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">useConsultationLogic.ts: updatePrice() ‚Üí Optimistic UI Update</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">PATCH /api/coach/consultation { price, enabled }</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">UPDATE table: coaches (Atomic field update)</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: consultationData (Synced)</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Precios negativos o absurdos. <em>Optimizaci√≥n:</em> Implementar
    validaci√≥n de Schema (Zod) en el endpoint para asegurar que el precio est√© entre $500 y $500.000.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="calendario-coach"></a> ## 9. üìÖ Calendario del Coach (Coach) [ACTUALIZADO]</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Ciclo de Vida de eMeets (Interno)</div>

    <div class="logic-layer">
      <span class="layer-label">üìå FARE 1: CREACI√ìN Y DISPONIBILIDAD</span>
      <div class="node ux-node">Coach: Abre Calendario ‚Üí Click en D√≠a (Futuro)</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è INTERACCI√ìN</span>
        <div class="node state-node">UI: Selector de Fecha (Nuevo Modal 2 Columnas: A√±os | Meses)</div>
        <div class="node ux-node">Coach: Click en Slot Horario ‚Üí Selecciona Cliente</div>
      </div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è L√ìGICA DE NEGOCIO</span>
        <div class="node hook-node">useCoachCalendarLogic.ts: handleCreateMeet()</div>
        <div class="node api-node">INSERT calendar_events { title, status: 'scheduled', ... }</div>
        <div class="node api-node">INSERT participants { rsvp_status: 'pending' (Client), 'confirmed' (Coach) }
        </div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå FASE 2: ESTADOS VISUALES (SEM√ÅFORO)</span>
      <div class="branch">
        <span class="status-pill pill-green">CONFIRMADA</span>
        <div class="node" style="border: 1px solid #FF7939; color: #FF7939;">Borde Naranja Intenso (Coach + Client
          Confirmed)</div>
      </div>
      <div class="branch">
        <span class="status-pill pill-yellow">INVITACI√ìN ENVIADA</span>
        <div class="node" style="border: 1px solid #ffccaa; color: #ffccaa;">Borde Beige/Suave (Client RSVP:
          Pending)
        </div>
        <div class="node state-node">Muestra conteo de participantes (ej. "0/1 Confirmados")</div>
      </div>
      <div class="branch">
        <span class="status-pill pill-red">CAMBIO SOLICITADO</span>
        <div class="node" style="border: 1px solid #ff4d4d; color: #ff4d4d;">Borde Rojo (Reschedule Request Pending)
        </div>
        <div class="node state-node">Muestra "Propuesta: [Nueva Fecha]" en lugar de texto est√°tico</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">üìå FASE 3: GESTI√ìN Y REPROGRAMACI√ìN</span>
      <div class="node ux-node">Coach: Click en Meet ‚Üí Modal de Detalle</div>
      <div class="branch">
        <span class="arrow">‚¨áÔ∏è ACCIONES</span>
        <div class="node hook-node">useCoachEvents.ts: Detecta `rsvp_status` y `reschedule_requests`</div>
        <div class="node ux-node">Opciones: "Cancelar", "Reprogramar" (Si confirmado), "Reenviar Invitaci√≥n" (Si
          pendiente)</div>
      </div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Arquitectura Modular:</strong> La l√≥gica est√° estrictamente separada:
    <br><code>useCoachEvents.ts</code>: Fetching y suscripci√≥n a cambios en DB (Real-time).
    <br><code>useCoachCalendarLogic.ts</code>: Manejo de interacci√≥n, validaci√≥n de fechas y creaci√≥n.
    <br><code>coach-calendar-screen.tsx</code>: √önicamente renderizado UI (Dumb Components).
  </p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="gestion-video-coach"></a> ## 10. üé• Gesti√≥n de Videos (Bunny.net) e Im√°genes (Supabase)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Subida de Media en Wizard de Producto</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Coach: Selecciona Archivo en Wizard</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Decision Branch: Image vs Video</span>
      <div class="branch">
        <span class="arrow">‚îú‚îÄ‚îÄ</span>
        <div class="node hook-node">IMAGEN: Subida Inmediata (Supabase)</div>
        <div class="node api-node">POST /api/upload-organized ‚Üí Retorna URL p√∫blica</div>
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node hook-node">VIDEO: Subida Diferida (Bunny.net)</div>
        <div class="node state-node">state: pendingVideoFile (Preview local con URL.createObjectURL)</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Final Trigger: Guardar/Publicar Producto</span>
      <div class="node ux-node">Coach: Click "Guardar" o "Publicar"</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">Si hay pendingVideoFile ‚Üí POST /api/bunny/upload-video (Stream)</div>
        <div class="node api-node">POST /api/products (Guarda URL de imagen ya subida + URL de video reci√©n subido)
        </div>
      </div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Regla de Oro:</strong> Las im√°genes de portada se suben <em>inmediatamente</em> al seleccionarlas
    para
    feedback visual r√°pido y persistencia simple. Los videos, al ser pesados y costosos (Bunny), se mantienen en
    memoria
    (Blob local) y <em>solo</em> se suben cuando el usuario confirma la creaci√≥n/edici√≥n del producto.
  </p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="gestion-documentos-coach"></a> ## 11. üìÑ Gesti√≥n de Documentos (Coach)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Librer√≠a de Conocimiento</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Coach: Upload PDF ‚Üí Asigna "Tema: Nutrici√≤n Pro"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">document-manager.tsx: handleDocUpload()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">Supabase Storage: /pdfs/coaches/{id}/*</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">INSERT table: document_topics { pdf_url, activity_id }</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: activityDocs (Ready for client download)</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> PDFs con scripts maliciosos. <em>Optimizaci√≥n:</em> Implementar
    escaneo
    de virus en el bucket de Supabase o forzar la visualizaci√≥n en un Sandboxed PDF Viewer.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="perfil-coach"></a> ## 12. üë§ Perfil del Coach (Coach)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Marca Personal</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Coach: Edita Bio ‚Üí Agrega Especialidad "Crossfit" ‚Üí Save</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">coach-profile-screen.tsx: handleUpdateProfile()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">UPDATE table: user_profiles { bio, specialties }</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: coachMasterProfile (Synced) ‚Üí UI: "Perfil actualizado"</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Suplantaci√≥n de identidad si se permite cambiar correos
    verificados.
    <em>Optimizaci√≥n:</em> Bloquear el cambio de Email una vez la cuenta es de tipo "Coach" y requerir ticket de
    soporte
    para modificaciones legales.
  </p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="onboarding-logic"></a> ## 13. üß† Formulario de Onboarding (L√≥gica)</p>
  <div class="logic-container">
    <div class="logic-title">üåÄ Workflow: Perfilado del Cliente</div>
    <div class="logic-layer">
      <span class="layer-label">UX ‚Üí Trigger</span>
      <div class="node ux-node">Client: Completa Step 7 ‚Üí Click "Listo, Empezar"</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Frontend Logic ‚Üí Hooks</span>
      <div class="node hook-node">onboarding-modal.tsx: handleSubmit()</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Backend Logic ‚Üí API/DB</span>
      <div class="node api-node">UPSERT: client_onboarding_responses (Answers mapping)</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">UPDATE: clients (Fisical data parsing)</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Data State ‚Üí UI</span>
      <div class="node state-node">state: userOnboarded = true ‚Üí (Close Modal)</div>
    </div>
  </div>
  <p><strong>‚ö†Ô∏è Scan de Vulnerabilidad:</strong> Desconexi√≥n durante el env√≠o de 7 pasos. <em>Optimizaci√≥n:</em>
    Implementar guardado parcial ("Draft") en cada step para que el usuario pueda retomar si se queda sin bater√≠a o
    se√±al.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="progreso-logic"></a> ## 14. ‚öôÔ∏è Arquitectura Core: Compras y Progreso</p>
  <div class="logic-container">
    <div class="logic-title">üåê 1. El Evento Gatillo: Validaci√≥n y Pago Exitoso</div>
    <div class="logic-layer">
      <span class="layer-label">Notificaci√≥n</span>
      <div class="node ux-node">Mercado Pago / Stripe: Envia Webhook (pago_aprobado)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Doble Check Antifraude</span>
      <div class="node api-node">API: GET /payments/{id} directo a Mercado Pago</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">API MP Devuelve: status real, fees, net_amount</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Registro Indestructible (banco)</span>
      <div class="node api-node">UPDATE tabla: banco (Guarda comprobantes exactos de MP)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Creaci√≥n de Compra (enrollment_id)</span>
      <div class="node hook-node">INSERT tabla: activity_enrollments</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">Se genera UUID √∫nico (enrollment_id) y fechas: dias_hasta_empezar, start_date
          (null), end_date</div>
      </div>
    </div>
  </div>

  <div class="logic-container">
    <div class="logic-title">üåÄ 2A. Flujo de Programas (Fitness y Nutrici√≥n)</div>
    <div class="logic-layer">
      <span class="layer-label">Activaci√≥n del Cliente</span>
      <div class="node ux-node">Cliente eval√∫a y presiona "Empezar Actividad" -> setea start_date y end_date reales
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Reglas Din√°micas</span>
      <div class="node api-node">Motor lee: product_conditional_rules (Filtra por lesiones, nivel, etc.)</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Lectura y Duplicaci√≥n Estructural</span>
      <div class="node hook-node">RPC: duplicate_program_details_on_enrollment</div>
      <div class="branch">
        <span class="arrow">‚îú‚îÄ‚îÄ</span>
        <div class="node api-node">Lee: periodos -> planificacion_ejercicios -> ejercicios_detalles</div>
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">Copia masiva generada a: progreso_cliente / progreso_cliente_nutricion</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Consolidaci√≥n Diaria (Triggers)</span>
      <div class="node state-node">Trigger de DB (ej. update_daily_progress_from_program) calcula sumatorias (kcal,
        mins) y UPSERT -> progreso_diario_actividad cruzado por enrollment_id</div>
    </div>
  </div>

  <div class="logic-container">
    <div class="logic-title">üåÄ 2B. Flujo de Talleres, Documentos y Sesiones</div>
    <div class="logic-layer">
      <span class="layer-label">Talleres (Workshops)</span>
      <div class="node hook-node">Al comprar: Habilita tabla taller_progreso_temas</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">Consolidaci√≥n: Si el coach marca asistencia o cliente termina m√≥dulo, API lo
          inserta en progreso_diario_actividad</div>
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Documentos / Sesiones</span>
      <div class="node hook-node">Al comprar: Otorga acceso directo reactivo</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">Consumo a destajo (document_progress) o Agendamiento de citas en el calendario
        </div>
      </div>
    </div>
  </div>

  <div class="logic-container">
    <div class="logic-title">üßπ 3. Vencimiento y Purga de Datos (Cosecha del Progreso)</div>
    <div class="logic-layer">
      <span class="layer-label">Vencimiento</span>
      <div class="node ux-node">La fecha actual cruza el "end_date" del activity_enrollment</div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">Extracci√≥n y Limpieza</span>
      <div class="node api-node">Las tablas pesadas y detalladas (progreso_cliente, nutricion) son eliminadas para
        liberar espacio de BD.</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">La Semilla Eterna: El progreso resumido queda congelado hist√≥ricamente en la tabla
          progreso_diario_actividad usando enrollment_id para diferenciar recompras del mismo producto.</div>
      </div>
    </div>
  </div>

  <hr />
  <p><a name="script-audit"></a> ## 15. üß™ Auditor√≠a de Scripts y Eficiencia (QA Dashboard) An√°lisis de los archivos
    cr√≠ticos del sistema para evaluaci√≥n de rendimiento, deuda t√©cnica y estabilidad.</p>
  <table>
    <colgroup>
      <col style="width: 14%" />
      <col style="width: 17%" />
      <col style="width: 17%" />
      <col style="width: 17%" />
      <col style="width: 17%" />
      <col style="width: 14%" />
    </colgroup>
    <thead>
      <tr class="header">
        <th style="text-align: left;">Script / Componente</th>
        <th style="text-align: center;">L√≠neas</th>
        <th style="text-align: center;">Importancia</th>
        <th style="text-align: center;">Redundancia</th>
        <th style="text-align: center;">Calificaci√≥n QA</th>
        <th style="text-align: left;">Observaciones del QA Tester</th>
      </tr>
    </thead>
    <tbody>
      <tr class="odd">
        <td style="text-align: left;"><code>PurchaseActivityModal.tsx</code></td>
        <td style="text-align: center;">~120 (MODULAR)</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> L√≥gica de pagos extra√≠da. UI fragmentada.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>ProductsManagement (Refactored)</code></td>
        <td style="text-align: center;">~1000</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> L√≥gica separada de la UI. Altamente mantenible
          y
          performante en mobile.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>useCreateProductLogic.ts (Refactored)</code></td>
        <td style="text-align: center;">~570</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> L√≥gica de Wizard extra√≠da y modularizada en 6
          sub-hooks
          especializados.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>csv-manager-enhanced.tsx</code></td>
        <td style="text-align: center;">1035</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO EXTREMO.</strong> L√≥gica totalmente extra√≠da a hooks
          especializados
          (useCsvActions, useCsvFileProcessor). UI limpia y modular.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>weekly-exercise-planner.tsx</code></td>
        <td style="text-align: center;">326</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;">F√âNIX. Refactorizado masivamente. La l√≥gica compleja migr√≥ a
          DayExercisesModal.tsx.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>CalendarView.tsx</code></td>
        <td style="text-align: center;">1032</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üü¢ 8/10</td>
        <td style="text-align: left;"><strong>DOMADO PARCIALMENTE.</strong> Reducido de ~4,000 a 1,032 l√≠neas.
          Fragmentaci√≥n avanzada en hooks, pero el core sigue siendo denso. </td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>MeetDetailModal.tsx</code></td>
        <td style="text-align: center;">666</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>UX PREMIUM.</strong> Reemplazado window.confirm nativo por modal
          personalizado con glassmorphism. Confirmaci√≥n de cancelaci√≥n con estilo OMNIA.
        </td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>coach-calendar-screen.tsx</code></td>
        <td style="text-align: center;">~160 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Monolito de 3k l√≠neas fragmentado. L√≥gica en hooks y UI
          en sub-componentes.</td>
      </tr>

      <tr class="even">
        <td style="text-align: left;"><code>ClientProfileView.tsx</code></td>
        <td style="text-align: center;">~140 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Perfil fragmentado en Header, Activity, Metrics y
          History.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>profile-screen.tsx</code></td>
        <td style="text-align: center;">140</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> Pantalla dividida en vistas especializadas
          (Client/Coach) y l√≥gica extra√≠da.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>useProfileScreenLogic.ts</code></td>
        <td style="text-align: center;">350</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>LIMPIO.</strong> Orquestador de estados para el perfil dual del
          usuario.
        </td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>workshop-schedule-manager.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizaci√≥n del gestor de horarios de talleres.
          L√≥gica de generaci√≥n de fechas movida a utils y estados complejos a hooks.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>client-product-modal.tsx</code></td>
        <td style="text-align: center;">120</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> Descompuesto en Hero, Details, Topics y
          Comments.
          L√≥gica en hook.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useClientProductLogic.ts</code></td>
        <td style="text-align: center;">380</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>CENTRALIZADO.</strong> Maneja pagos, l√≠mites de plan y cach√© de
          talleres.
        </td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>clients-screen.tsx</code></td>
        <td style="text-align: center;">137 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üü¢ 9/10</td>
        <td style="text-align: left;"><strong>REFACTOR FINALIZADO.</strong> Monolito segmentado en Hooks y
          Componentes
          UI. Extremadamente mantenible.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>search-screen.tsx</code></td>
        <td style="text-align: center;">~150 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Filtros y resultados extra√≠dos. L√≥gica centralizada en
          hook.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>workshop-client-view.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizado en arquitectura de Pilares.
          L√≥gica extra√≠da a hooks y UI fragmentada en sub-componentes especializados.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useSearchScreenLogic.ts</code></td>
        <td style="text-align: center;">250</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>CENTRALIZADO.</strong> Maneja b√∫squeda local, stack de navegaci√≥n y
          load
          de coaches/actividades.
        </td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>ClientDetailModal.tsx</code></td>
        <td style="text-align: center;">766</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> UI segmentada y l√≥gica extra√≠da al hook
          useClientDetailLogic.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>useClientDetailLogic.ts</code></td>
        <td style="text-align: center;">387</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>LIMPIO.</strong> Orquestador de estados para el detalle del cliente.
        </td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>purchased-activity-card.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizaci√≥n de la tarjeta principal de productos
          comprados.
          L√≥gica de progreso y tipos de producto extra√≠da a hooks. UI fragmentada en sub-componentes.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>onboarding-modal.tsx</code></td>
        <td style="text-align: center;">~70 (MODULAR)</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> Monolito de 700 l√≠neas segmentado. L√≥gica
          extra√≠da
          y UI dividida en sub-componentes.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useOnboardingLogic.ts</code></td>
        <td style="text-align: center;">~350</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>CENTRALIZADO.</strong> Maneja wizard de 7 pasos, uploads de avatar y
          m√∫ltiples upserts en DB.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>RuleEditor.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Monstruo de reglas dividido en 5 sub-componentes UI y
          hook de l√≥gica useRuleEditorLogic.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>ProductPreviewCard.tsx</code></td>
        <td style="text-align: center;">~100 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Preview gigante dividido en sub-componentes (Image, Info,
          Details, Action) y hook de l√≥gica.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>plan-management.tsx</code></td>
        <td style="text-align: center;">~140 (MODULAR)</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Gesti√≥n de precios simplificada. Data est√°tica en utils,
          UI atomizada en sub-componentes.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>messages/page.tsx</code></td>
        <td style="text-align: center;">~98 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>DOMADO.</strong> Chat segmentado en componentes de UI. L√≥gica Real-time en
          hook.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useMessagesScreenLogic.ts</code></td>
        <td style="text-align: center;">~300</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>CENTRALIZADO.</strong> Orquestador de chats, suscripciones y polling
          en
          tiempo real.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>activity-calendar.tsx</code></td>
        <td style="text-align: center;">~80 (MODULAR)</td>
        <td style="text-align: center;">MEDIA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>MODULARIZADO.</strong> L√≥gica de calendario y drag-and-drop extra√≠da a
          hook. UI segmentada (Grid, Header, Dialog).</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useActivityCalendarLogic.ts</code></td>
        <td style="text-align: center;">~250</td>
        <td style="text-align: center;">MEDIA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 9/10</td>
        <td style="text-align: left;"><strong>CENTRALIZADO.</strong> Maneja selecci√≥n de fechas, carga de m√©tricas y
          l√≥gica compleja de movimiento de actividades.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>personal-info.tsx</code></td>
        <td style="text-align: center;">1</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizado en arquitectura de Pilares (PersonalInfo/).
          Fragmentado en B√°sicos, Metas, Restricciones y Perfil.</td>
      </tr>
      <tr class="odd">
        <td style="text-align: left;"><code>useTodayScreenLogic.ts</code></td>
        <td style="text-align: center;">346</td>
        <td style="text-align: center;">CR√çTICA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>FRAGMENTACI√ìN TOTAL.</strong> Orquestador central refinado.
          L√≥gica delegada en 5 hooks especializados (Ui, Data, Actions, Workshop, ExerciseEditing). UI inmersiva con
          fondos blureados din√°micos.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>media-selection-modal.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">MEDIA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizado en arquitectura de Pilares.
          L√≥gica de Bunny y Storage integrada en un hook limpio. UI fragmentada.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>profile-edit-modal.tsx</code></td>
        <td style="text-align: center;">1 (MODULAR)</td>
        <td style="text-align: center;">ALTA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>CAZADO.</strong> Refactorizaci√≥n m√≥vil del editor de perfil.
          Arquitectura espejada de PersonalInfo para consistencia multiplataforma.</td>
      </tr>
      <tr class="even">
        <td style="text-align: left;"><code>exercise-progress-list.tsx</code></td>
        <td style="text-align: center;">383</td>
        <td style="text-align: center;">MEDIA</td>
        <td style="text-align: center;">BAJA</td>
        <td style="text-align: center;">üîµ 10/10</td>
        <td style="text-align: left;"><strong>ESTABLE.</strong> Recientemente corregido y optimizado para el
          guardado
          imperativo de cambios.</td>
      </tr>
    </tbody>
  </table>
  <p><strong>Leyenda de Calificaci√≥n:</strong> - üîµ <strong>9-10</strong>: Excelente arquitectura, f√°cil de
    mantener. -
    üü¢ <strong>7-8</strong>: Estable, pero con margen de optimizaci√≥n en rendimiento. - üü° <strong>5-6</strong>:
    Deuda
    t√©cnica acumulada. Dif√≠cil de leer/testear. Requiere refactorizaci√≥n. - üî¥ <strong>&lt;5</strong>: C√≥digo
    peligroso,
    propenso a errores y muy ineficiente.</p>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <p><a name="logic-map"></a> ## 16. üå≥ Mapa de Salud Operativa y Estructura (Mission Control)</p>
  <div class="tree-container">
    <div class="tree-title">üõ∞Ô∏è OMNIA MISSION CONTROL: ARQUITECTURA VISUAL</div>

    <span class="tree-division">üì± [APP CLIENTE]</span>
    <div class="tree-branch">
      <span class="tree-tab">üè† HOY / EXPLORAR</span>
      <div class="tree-branch">
        <span class="tree-action">Consumir Rutinas Diarias</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO Y FRAGMENTADO</span>
          <code>TodayScreen (useTodayScreenLogic.ts)</code>
          <span class="line-count">346 lines</span>
        </div>
      </div>

      <span class="tree-tab">üîç MARKETPLACE</span>
      <div class="tree-branch">
        <span class="tree-action">Buscar Servicios y Coaches</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>search-screen.tsx</code>
          <span class="line-count">~150 lines</span>
        </div>
        <span class="tree-action">Planificaci√≥n de Talleres (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>WorkshopSchedule/</code>
          <span class="line-count">~600 lines (Refactored)</span>
          <span class="hook-ref">ü™ù useWorkshopScheduleLogic</span>
        </div>
        <span class="tree-action">Mis Actividades (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>PurchaseActivityModal.tsx</code>
          <span class="line-count">~120 lines</span>
          <span class="hook-ref">ü™ù usePurchaseActivityLogic</span>
        </div>
        <span class="tree-action">Detalle de Producto (Modal)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ MODULAR</span>
          <code>client-product-modal.tsx</code>
          <span class="line-count">120 lines</span>
          <span class="hook-ref">ü™ù useClientProductLogic</span>
        </div>
      </div>

      <span class="tree-tab">üìÖ CALENDARIO</span>
      <div class="tree-branch">
        <span class="tree-action">Vista Mensual y Meets</span>
        <div class="tree-detail">
          <span class="status-pill pill-yellow">üü° TIT√ÅN DOMADO</span>
          <code>CalendarView.tsx</code>
          <span class="line-count">1032 lines</span>
        </div>
        <span class="tree-action">Agendar Sesi√≥n eMeet</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ MODULAR</span>
          <code>activity-calendar.tsx</code>
          <span class="line-count">~80 lines</span>
          <span class="hook-ref">ü™ù useActivityCalendarLogic</span>
        </div>
      </div>

      <span class="tree-tab">üí¨ CHAT</span>
      <div class="tree-branch">
        <span class="tree-action">Comunicaci√≥n Coach-Client</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>messages/page.tsx</code>
          <span class="line-count">~98 lines</span>
          <span class="hook-ref">ü™ù useMessagesLogic</span>
        </div>
      </div>

      <span class="tree-tab">üöÄ ONBOARDING</span>
      <div class="tree-branch">
        <span class="tree-action">Perfilado e Inicio</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ MODULAR</span>
          <code>onboarding-modal.tsx</code>
          <span class="line-count">~70 lines</span>
          <span class="hook-ref">ü™ù useOnboardingLogic</span>
        </div>
      </div>

      <span class="tree-tab">üë§ PERFIL</span>
      <div class="tree-branch">
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>ClientProfileView.tsx</code>
          <span class="line-count">~140 lines</span>
        </div>
        <div class="tree-detail">
          <span class="status-pill pill-green">üü¢ SALUDABLE</span>
          <code>biometrics-modal.tsx</code>
          <span class="line-count">415 lines</span>
        </div>
        <span class="tree-action">Detalle de Usuario (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>PersonalInfo/</code>
          <span class="line-count">~1000 lines (5 components)</span>
          <span class="hook-ref">ü™ù usePersonalInfoLogic</span>
        </div>
        <span class="tree-action">Edici√≥n de Perfil Mobile (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>ProfileEdit/</code>
          <span class="line-count">~700 lines (Mobile)</span>
          <span class="hook-ref">ü™ù useProfileEditLogic</span>
        </div>
        <span class="tree-action">Vista de Talleres (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>WorkshopClientView/</code>
          <span class="line-count">~1000 lines (4 components)</span>
          <span class="hook-ref">ü™ù useWorkshopLogic</span>
        </div>
        <span class="tree-action">Selecci√≥n de Media (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>MediaSelection/</code>
          <span class="line-count">~1000 lines (3 components)</span>
          <span class="hook-ref">ü™ù useMediaSelectionLogic</span>
        </div>
      </div>
    </div>

    <span class="tree-division">üë®‚Äçüè´ [COACH DASHBOARD]</span>
    <div class="tree-branch">
      <span class="tree-tab">üë• CLIENTES</span>
      <div class="tree-branch">
        <span class="tree-action">Detalle de Cliente (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ MODULARIZADO</span>
          <code>ClientDetailModal.tsx</code>
          <span class="line-count">765 lines</span>
        </div>
        <span class="tree-action">L√≥gica de Detalle (Hook)</span>
        <div class="tree-detail">
          <span class="status-pill pill-green">üü¢ SALUDABLE</span>
          <code>useClientDetailLogic.ts</code>
          <span class="line-count">387 lines</span>
        </div>
        <span class="tree-action">Metas de Rendimiento (List)</span>
        <div class="tree-detail">
          <span class="status-pill pill-green">üü¢ SALUDABLE</span>
          <code>exercise-progress-list.tsx</code>
          <span class="line-count">383 lines</span>
        </div>
      </div>

      <span class="tree-tab">üõí PRODUCTOS</span>
      <div class="tree-branch">
        <span class="tree-action">Gesti√≥n del Cat√°logo</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ MODULAR</span>
          <code>ProductsManagement (Index)</code>
          <span class="line-count">89 lines</span>
        </div>
        <span class="tree-action">Wizard de Creaci√≥n (Logic)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>useCreateProductLogic.ts</code>
          <span class="line-count">~570 lines</span>
        </div>
        <span class="tree-action">Planificador Diario</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ OPTIMIZADO</span>
          <code>DayExercisesModal.tsx</code>
          <span class="line-count">~430 lines</span>
        </div>
      </div>

      <span class="tree-tab">üìÖ CALENDARIO</span>
      <div class="tree-branch">
        <span class="tree-action">Gesti√≥n de Agenda y eMeets</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ DOMADO</span>
          <code>coach-calendar-screen.tsx</code>
          <span class="line-count">~160 lines</span>
          <span class="hook-ref">ü™ù useCoachCalendarLogic, useCoachEvents</span>
        </div>
      </div>

      <span class="tree-tab">üì¶ ALMACENAMIENTO</span>
      <div class="tree-branch">
        <span class="tree-action">Selecci√≥n de Media (Modular)</span>
        <div class="tree-detail">
          <span class="status-pill pill-blue">üîµ CAZADO</span>
          <code>MediaSelection/</code>
          <span class="line-count">~1000 lines (Modular)</span>
        </div>
        <span class="tree-action">Gesti√≥n Bunny.net</span>
        <div class="tree-detail">
          <span class="status-pill pill-green">üü¢ SALUDABLE</span>
          <code>StorageUsageWidget</code>
          <span class="line-count">~150 lines</span>
        </div>
      </div>

      <span class="tree-tab">üìä CONTENIDO / CSV</span>
      <div class="tree-branch">
        <span class="tree-action">Carga Masiva de Librer√≠a</span>
        <div class="tree-detail">
          <span class="status-pill pill-green">üü¢ CAZADO Y FRAGMENTADO</span>
          <code>csv-manager-enhanced.tsx</code>
          <span class="line-count">~350 lines</span>
        </div>
      </div>
    </div>
  </div>
  <p><a href="#indice-de-navegacion">Volver al √≠ndice</a></p>
  <hr />
  <h2 id="core-data-structure">üóÑÔ∏è Estructura de Datos Core (Schema)</h2>
  <div class="logic-container" style="background: #0f1218; border: 1px solid #30363d;">
    <div class="logic-title" style="color: #4faaff; border-color: #4faaff;">TABLAS CR√çTICAS DE OMNIA</div>

    <div class="logic-layer">
      <span class="layer-label">Identity & Roles</span>
      <div class="node state-node">users (id, email, role: 'coach'|'client')</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node state-node">user_profiles (bio, avatar_url, biometrics)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">Marketplace & Content</span>
      <div class="node api-node">products (Title, Price, Type: 'workshop'|'program'|'document')</div>
      <div class="branch">
        <span class="arrow">‚îú‚îÄ‚îÄ</span>
        <div class="node api-node">activities (Instancia comprada, progress_tracking)</div>
      </div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">activity_enrollments (Link User-Activity, status: 'active'|'completed')</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">Calendar System</span>
      <div class="node hook-node">calendar_events (Start/End, Type: 'meet'|'workshop')</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node hook-node">calendar_event_participants (RSVP Status: 'pending'|'confirmed'|'cancelled')</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">Monetization</span>
      <div class="node pill-yellow">plans (Suscripci√≥n del Coach: 'free', 'basic', 'black', 'premium')</div>
    </div>
  </div>

  <hr />
  <h2 id="master-purchase-flow">üöÄ 17. Flujo Maestro de Compra Personalizada</h2>
  <div class="logic-container" style="background: #0f1218; border: 1px solid #30363d;">
    <div class="logic-title" style="color: #FF7939; border-color: #FF7939;">üåÄ WORKFLOW: DE PAGO A PROGRESO</div>

    <div class="logic-layer">
      <span class="layer-label">STEP 1: PURCHASE (MERCADO PAGO)</span>
      <div class="node ux-node">Client: Realiza Pago ‚Üí Webhook / Success Redirect</div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node api-node">DB: Insert activity_enrollments (Status: active, start_date: chosen)</div>
      </div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">STEP 2: ADAPTIVE DATA RETRIEVAL (VIEW)</span>
      <div class="node api-node">SELECT * FROM client_full_profile WHERE client_id = ...</div>
      <div class="node state-node">Context: Biometrics + Injuries + Onboarding Answers (Unified JSON)</div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">STEP 3: PERSONALIZATION ENGINE</span>
      <div class="node hook-node">PersonalizationEngine: applyPersonalization(baseItem, profile, rules)</div>
      <div class="node pill-blue">Logic: Matcheo de JSONB Criteria (Gender, Age, Weight, Injury detection)</div>
    </div>

    <div class="logic-layer">
      <span class="layer-label">STEP 4: INSTANTIATION (INITIALIZE-PROGRESS)</span>
      <div class="node api-node">Router: api/activities/initialize-progress</div>
      <div class="branch">
        <span class="arrow">‚îú‚îÄ‚îÄ</span>
        <div class="node pill-green">FITNESS: Insert into progreso_cliente (detalles_series)</div>
      </div>
      <div class="branch">
        <span class="arrow">‚îî‚îÄ‚îÄ</span>
        <div class="node pill-green">NUTRITION: Insert into progreso_cliente_nutricion (macros)</div>
      </div>
    </div>
  </div>

  <div class="tree-container">
    <div class="tree-title">üìã DIAGRAMA DE SECUENCIA T√âCNICA</div>
    <div style="font-family: monospace; white-space: pre; color: #81c784; line-height: 1.4;">
      Cliente (App) initialize-progress Supabase (View/Tables) Engine
      | | | |
      |--- POST (activity)--| | |
      | |--- SELECT Profile/Rules ->| |
      | |&lt;--- [Data Context] -------| |
      | | | |
      | |--- APPLY RULES -------------------------------->|
      | |&lt;------------------------- [Personalized Items]-|
      | | | |
      | |--- INSERT PROGRESO ------>| |
      | |&lt;--- [Success Confirm] ----| |
      |&lt;-- [FINALIZADO] ----| | |
    </div>
    <p style="margin-top: 20px; color: #8b949e;"><em>Nota: Se agreg√≥ soporte para enrollment_id segregado, permitiendo
        el historial de recompras sin colisi√≥n de datos.</em></p>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <hr/>
  <h2 id="motor-adaptativo-omv2">‚öôÔ∏è Motor Adaptativo OMNIA Om_v2</h2>
  <div class="logic-container" style="background:#0d1117;border:1px solid #30363d;">
    <div class="logic-title" style="color:#FF7939;border-color:#FF7939;">üß† ARQUITECTURA: REGLAS ID-CENTRIC</div>
    <p style="color:#ccc;">El Motor Adaptativo Om_v2 personaliza cada ejercicio de un programa en el momento de compra.
    En lugar de l√≥gica hardcodeada, extrae multiplicadores de la tabla <code>adaptive_rules_catalog</code> y los cruza con el perfil del cliente.</p>
    <div class="logic-layer">
      <span class="layer-label">TABLAS CLAVE</span>
      <div class="node" style="background:rgba(255,121,57,0.1);border:1px solid #FF7939;color:#FF7939;">
        <strong>adaptive_rules_catalog</strong> ‚Äî Cat√°logo de reglas con multiplicadores kg/series/reps<br/>
        <strong>activities.adaptive_rule_ids integer[]</strong> ‚Äî IDs de reglas que el Coach activ√≥ para el programa<br/>
        <strong>clients.profile_rule_ids integer[]</strong> ‚Äî IDs de reglas que describen el perfil del cliente<br/>
        <strong>clients.injury_rule_ids integer[]</strong> ‚Äî IDs de lesiones del cliente
      </div>
    </div>
    <div class="logic-layer">
      <span class="layer-label">FLUJO DE COMPRA ADAPTATIVA</span>
      <div class="node" style="background:rgba(35,134,54,0.1);border:1px solid #4caf50;color:#81c784;">
        1. Coach configura Matriz (Baja/Media/Alta) ‚Üí se guardan IDs reales en <code>activities.adaptive_rule_ids</code><br/>
        2. Cliente compra el programa ‚Üí se llama <code>initialize-progress/route.ts</code><br/>
        3. El API cruza <code>adaptive_rule_ids ‚à© (profile_rule_ids ‚à™ injury_rule_ids)</code> del cliente<br/>
        4. Se acumulan multiplicadores k√ós√ór via producto: exp(SUM(ln(factor)))<br/>
        5. Se aplica sobre <code>detalle_series</code> de cada ejercicio ‚Üí se persiste en <code>progreso_cliente</code>
      </div>
    </div>
  </div>

  <h3>üìä Tabla Maestra de Multiplicadores (Intensidad Media)</h3>
  <div class="logic-container" style="background:#0d1117;border:1px solid #30363d;">
    <div class="logic-title" style="color:#a371f7;border-color:#a371f7;">FASE 1: NIVEL DE ENTRENAMIENTO</div>
    <table style="color:#ccc;width:100%;font-family:monospace;font-size:12px;">
      <tr style="border-bottom:1px solid #333;"><th>Categor√≠a</th><th>Rango</th><th>k (Peso)</th><th>s (Series)</th><th>r (Reps)</th></tr>
      <tr><td>Nivel</td><td>Beginner</td><td>0.85</td><td>0.80</td><td>0.85</td></tr>
      <tr><td>Nivel</td><td>Intermediate</td><td>1.00</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Nivel</td><td>Advanced</td><td>1.15</td><td>1.20</td><td>1.10</td></tr>
    </table>
    <div class="logic-title" style="color:#a371f7;border-color:#a371f7;margin-top:15px;">FASE 2: CARACTER√çSTICAS METAB√ìLICAS</div>
    <table style="color:#ccc;width:100%;font-family:monospace;font-size:12px;">
      <tr style="border-bottom:1px solid #333;"><th>Categor√≠a</th><th>Rango</th><th>k (Peso)</th><th>s (Series)</th><th>r (Reps)</th></tr>
      <tr><td>Edad</td><td>Joven (&lt;18)</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Edad</td><td>Joven Adulto (18-25)</td><td>1.00</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Edad</td><td>Plenitud (26-35)</td><td>1.05</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Edad</td><td>Maduro I (36-45)</td><td>1.00</td><td>0.95</td><td>0.95</td></tr>
      <tr><td>Edad</td><td>Maduro II (46-55)</td><td>0.90</td><td>0.90</td><td>0.95</td></tr>
      <tr><td>Edad</td><td>Master I (56-65)</td><td>0.85</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Edad</td><td>Senior (&gt;65)</td><td>0.75</td><td>0.80</td><td>0.85</td></tr>
      <tr><td>Peso</td><td>Muy Ligero (&lt;50kg)</td><td>0.80</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Peso</td><td>Ligero (50-65kg)</td><td>0.90</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Peso</td><td>Medio (66-80kg)</td><td>1.00</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Peso</td><td>Pesado (81-95kg)</td><td>1.05</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>Peso</td><td>Intenso (96-110kg)</td><td>1.10</td><td>0.95</td><td>0.95</td></tr>
      <tr><td>Peso</td><td>Muy Pesado (&gt;110kg)</td><td>1.15</td><td>0.90</td><td>0.90</td></tr>
      <tr><td>BMI</td><td>Bajo Peso (&lt;18.5)</td><td>0.90</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>BMI</td><td>Normal (18.5-29.9)</td><td>1.00</td><td>1.00</td><td>1.00</td></tr>
      <tr><td>BMI</td><td>Sobrepeso (25-29.9)</td><td>1.00</td><td>0.95</td><td>0.95</td></tr>
      <tr><td>BMI</td><td>Obesidad (‚â•30)</td><td>1.00</td><td>1.00</td><td>1.00</td></tr>
    </table>
    <div class="logic-title" style="color:#f85149;border-color:#f85149;margin-top:15px;">FASE 3: LESIONES (CL√çNICO)</div>
    <table style="color:#ccc;width:100%;font-family:monospace;font-size:12px;">
      <tr style="border-bottom:1px solid #333;"><th>Lesi√≥n</th><th>k (Peso)</th><th>s (Series)</th><th>r (Reps)</th></tr>
      <tr><td>Lumbalgia Cr√≥nica</td><td>0.75</td><td>0.85</td><td>0.85</td></tr>
      <tr><td>Hernia Discal L4-L5/S1</td><td>0.65</td><td>0.75</td><td>0.80</td></tr>
      <tr><td>Escoliosis</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Rodilla</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Hombro</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Cervicales</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Mu√±eca / Mano</td><td>0.85</td><td>0.95</td><td>0.90</td></tr>
      <tr><td>Tobillo</td><td>0.85</td><td>0.95</td><td>0.90</td></tr>
      <tr><td>Cadera</td><td>0.80</td><td>0.85</td><td>0.90</td></tr>
      <tr><td>Tendinitis</td><td>0.85</td><td>0.90</td><td>0.90</td></tr>
    </table>
    <p style="color:#666;font-size:11px;margin-top:10px;">
      Escalado de Rigidez: <strong>Baja</strong> = factor√ó0.3 | <strong>Media</strong> = factor√ó1.0 | <strong>Alta</strong> = factor√ó1.5
      aplicado sobre la f√≥rmula: <code>1 + (val - 1) √ó escala</code>
    </p>
  </div>

  <h3>üîç Query de Auditor√≠a: Impacto de Reglas por Cliente/Programa</h3>
  <div class="logic-container" style="background:#0d1117;border:1px solid #30363d;">
    <div class="logic-title" style="color:#58a6ff;border-color:#58a6ff;">AUDIT QUERY ‚Äî Cruce Programa vs Cliente</div>
    <pre style="color:#c9d1d9;font-size:11px;background:#161b22;padding:15px;border-radius:8px;overflow-x:auto;">
-- ¬øQu√© reglas del Programa impactan al Cliente?
WITH simulacion AS (
    SELECT r.name, r.kg, r.series, r.repetiiiciones as reps,
           (r.id = ANY(c.profile_rule_ids) OR r.id = ANY(c.injury_rule_ids)) as match
    FROM public.activities a
    JOIN public.adaptive_rules_catalog r ON r.id = ANY(a.adaptive_rule_ids)
    CROSS JOIN public.clients c
    WHERE a.id = [ACTIVITY_ID] AND c.id = [CLIENT_UUID]
)
SELECT
    regla as "Regla en el Programa",
    CASE WHEN match THEN '‚úÖ IMPACTA' ELSE '‚ùå No aplica' END as "Estado",
    kg as "K", series as "S", reps as "R"
FROM simulacion ORDER BY match DESC;</pre>
  </div>

  <h3>üöÄ Query de Simulaci√≥n de Compra: Progresi√≥n Adaptada por Ejercicio</h3>
  <div class="logic-container" style="background:#0d1117;border:1px solid #30363d;">
    <div class="logic-title" style="color:#58a6ff;border-color:#58a6ff;">SIMULATION QUERY ‚Äî Progresi√≥n Base vs Adaptada</div>
    <pre style="color:#c9d1d9;font-size:11px;background:#161b22;padding:15px;border-radius:8px;overflow-x:auto;">
WITH multiplicadores AS (
    SELECT
        exp(sum(ln(r.kg)))::numeric            as k_total,
        exp(sum(ln(r.series)))::numeric         as s_total,
        exp(sum(ln(r.repetiiiciones)))::numeric as r_total
    FROM public.activities a
    JOIN public.adaptive_rules_catalog r ON r.id = ANY(a.adaptive_rule_ids)
    CROSS JOIN public.clients c
    WHERE a.id = [ACTIVITY_ID] AND c.id = [CLIENT_UUID]
      AND (r.id = ANY(c.profile_rule_ids) OR r.id = ANY(c.injury_rule_ids))
),
dias_planificados AS (
    SELECT numero_semana, 'lunes' as dia, lunes as ej FROM public.planificacion_ejercicios
    WHERE actividad_id = [ACTIVITY_ID] AND lunes IS NOT NULL AND lunes::text != '{}'
    UNION ALL SELECT numero_semana, 'martes',    martes    FROM public.planificacion_ejercicios WHERE actividad_id = [ACTIVITY_ID] AND martes IS NOT NULL AND martes::text != '{}'
    /* ... dem√°s d√≠as ... */
),
ejercicios_del_dia AS (
    SELECT DISTINCT d.numero_semana, d.dia, (ej_item->>'id')::int as ejercicio_id
    FROM dias_planificados d,
         jsonb_array_elements(CASE WHEN jsonb_typeof(d.ej->'ejercicios')='array' THEN d.ej->'ejercicios' ELSE '[]'::jsonb END) as ej_item
),
ejercicios_con_detalle AS (
    SELECT e.numero_semana, e.dia, ed.nombre_ejercicio,
           TRIM(BOTH '"' FROM ed.detalle_series::text) as ds_texto
    FROM ejercicios_del_dia e JOIN public.ejercicios_detalles ed ON ed.id = e.ejercicio_id
    WHERE ed.detalle_series IS NOT NULL
),
sets_unnested AS (
    SELECT numero_semana, dia, nombre_ejercicio, ds_texto,
           ordinality as set_num,
           TRIM(BOTH ' ()' FROM set_text) as set_clean
    FROM ejercicios_con_detalle,
         unnest(string_to_array(ds_texto, ';')) WITH ORDINALITY AS t(set_text, ordinality)
),
sets_adaptados AS (
    SELECT numero_semana, dia, nombre_ejercicio, ds_texto, set_num,
        '(' ||
            CASE WHEN split_part(set_clean,'-',1)::numeric=0 THEN '0'
                 ELSE (ROUND(split_part(set_clean,'-',1)::numeric * m.k_total / 2.5)*2.5)::text END
        || '-' || ROUND(split_part(set_clean,'-',2)::numeric * m.r_total)::text
        || '-' || ROUND(split_part(set_clean,'-',3)::numeric * m.s_total)::text
        || ')' as set_adaptado
    FROM sets_unnested, multiplicadores m
    WHERE set_clean != '' AND set_clean ~ '^[0-9]'
)
SELECT
    'S' || numero_semana || ' - ' || initcap(dia)        as "üìÖ Planificaci√≥n",
    nombre_ejercicio                                       as "üèãÔ∏è Ejercicio",
    ds_texto                                               as "üìã Progresi√≥n Base",
    string_agg(set_adaptado, '; ' ORDER BY set_num)       as "‚ö° Progresi√≥n Adaptada"
FROM sets_adaptados
GROUP BY numero_semana, dia, nombre_ejercicio, ds_texto
ORDER BY numero_semana,
    CASE dia WHEN 'lunes' THEN 1 WHEN 'martes' THEN 2 WHEN 'miercoles' THEN 3
             WHEN 'jueves' THEN 4 WHEN 'viernes' THEN 5 WHEN 'sabado' THEN 6 ELSE 7 END,
    nombre_ejercicio;</pre>
    <p style="color:#8b949e;font-size:11px;margin-top:10px;">
      Formato de <code>detalle_series</code>: <code>(peso_kg-reps-sets); (peso_kg-reps-sets)</code><br/>
      Redondeo de peso: m√∫ltiplos de 2.5kg para compatibilidad con discos de gimnasio real.
    </p>
  </div>

  <h3>üóÑÔ∏è Estructura de Columnas Clave</h3>
  <div class="logic-container" style="background:#0d1117;border:1px solid #30363d;">
    <div class="logic-title" style="color:#e3b341;border-color:#e3b341;">SCHEMA REFERENCE</div>
    <pre style="color:#c9d1d9;font-size:11px;background:#161b22;padding:15px;border-radius:8px;">
-- activities (Programas del Coach)
adaptive_rule_ids  integer[]   -- IDs del cat√°logo que el Coach activ√≥ en la Matriz
-- (adaptive_config ELIMINADO ‚Äî se usa solo adaptive_rule_ids)

-- clients (Perfil del Cliente)
profile_rule_ids   integer[]   -- Nivel, Edad, Peso, BMI, Sexo
injury_rule_ids    integer[]   -- Lesiones activas del cliente

-- adaptive_rules_catalog (Cat√°logo maestro)
id          serial            -- ID √∫nico de la regla
name        text              -- "Edad: Plenitud (26-35) (Media)"
category    text              -- level | age | weight | bmi | gender | injury
intensity   text              -- baja | media | alta
phase       integer           -- 1: Nivel, 2: Caracter√≠sticas, 3: Lesiones
kg          numeric           -- Multiplicador de carga
series      numeric           -- Multiplicador de series
repetiiiciones numeric        -- Multiplicador de repeticiones (nota: typo legacy en DB)</pre>
    <p style="color:#f85149;font-size:11px;"><strong>‚ö†Ô∏è NOTA T√âCNICA:</strong> El campo <code>repetiiiciones</code> tiene un typo triple-i en la DB. No cambiar para evitar breaking change.</p>
  </div>

</body>
</html>